adblock#.uc.js


概要

	Adblock/Adblock plus（以下ADB）の劣化版.
	一応単に広告を非表示にするのではなく読み込み自体をブロックしてるつもり.
	「ツール」メニュー内にメニューを2つ作成する.
	ブロックしたURLはエラーコンソールに出力される.
	コードの汚さ/起動などにかかる時間を犠牲にしてでもマッチ処理を速くすることを基本方針としている.


フィルタについて

	ADBのフィルタと基本的には同じだが, 一部非互換/未実装部分がある.
	同梱のAdblock Adblock plus用リスト変換.htmlで変換できる(不完全).
	フィルタは 単純文字列 > アスタリスク > 正規表現の順で遅くなる.
	速度遅延を気にする人はできるだけ単純文字列で済ませられるようにフィルタを作るとよい（正規表現でまとめないでバラの単純文字列にする 等）.
		参考: Firefox 3.6.2では 単純文字列:正規表現 = 1:13 程度. 実際には正規表現は複雑さによりさらに遅くなると思われる.
		（indexOf と RegExp の速度比較 - m2 - http://d.hatena.ne.jp/miya2000/20100330/p0 より）
	また, 10/12/30版よりマッチしたときに情報を記録するようにした関係で, マッチしたときの処理時間が数ミリ秒遅くなった.

	* 単純文字列で指定した場合, 部分一致/大文字小文字区別有りのフィルターとなる.
		* ただし,「/ads/」のように前後に「/」が付く物は正規表現フィルタと誤認識されるのを防ぐため,「*/ads/*」と表記する.

	* 正規表現/アスタリスク/() 対応.
		* 正規表現は「/」で括ること（ADBと同じ）.
			* filter: 中に書く場合のみ, 正規表現中の「\」を「\\」とエスケープする必要がある. (Filter Managerから追加する場合は必要なし)
		* アスタリスクを使用するフィルターは「+」で括ること（独自仕様のため注意）.
			* 設定により「+」無しでもアスタリスクが含まれているフィルタを自動的にアスタリスクフィルタと認識するようにできる(デフォルトでは無効/未テストのため注意).
			* アスタリスクフィルタは本家と違い, 正規表現に変換せずにフィルタリングするため本家より速いはず.
			* アスタリスクの数分だけ単純文字列より遅くなる(1個->2倍, 2個->3倍, ...).
		* 「()」を使用するフィルターは正規表現で表記すること.

	* 前方一致/後方一致フィルタ対応
		* 前方一致は先頭に, 後方一致は最後に「|」をつける.
		* 前方一致/後方一致フィルタには単純文字列とアスタリスクしか使用できない.
		* 前方一致と後方一致を同時に使用して完全一致ということはできない.完全一致させたい時は正規表現を使って下さい.
		* 未検証だが速度はあまり速くないと思う.

	* ホワイトリスト(マッチしたURLをブロックしない)対応
		* ホワイトリストは先頭に「@@」をつける.
		* ホワイトリストにはすべての種類のフィルタが使用できる.

	* フィルタオプション(最後尾に$つけてファイルの種類を指定するフィルター)未対応
	* domain指定フィルター(先頭に「||」をつけてドメインのみを対象にするフィルター)未対応
	* CSSによる要素非表示フィルタ未対応(対応予定無) -> userContent.css/Stylishでどうぞ
	* フィルタの外部URL読み込み/自動更新未対応

	* adblock#.uc.js内のコメントも参照のこと.


フィルターの読み込みについて

	10/12/30版から, フィルターの読み込み方法が大きく変わった.
	基本的にスクリプト内の filter: から読み込むことはせず, Global Storageで管理するようになった.
	ただし,
		* 初回起動時/Global Storageのデータを削除した時などでGlobal Storageにデータがない場合
			(Global Storageのデータの削除方法については https://developer.mozilla.org/en/dom/storage#Storage_location_and_clearing_the_data を参照)
		* オプション「forceLoadFromScript」がtrueになっている場合
		* 何らかの原因でGlobal Storageからの読み込みに問題が発生した場合
	は従来通り filter: から読み込む.
	filter: から読み込んだ場合は, その旨が理由とともにエラーコンソールに出力される.

	Filter Managerはフィルターの並べ替えや, 大幅なフィルターの変更などはやりにくいため,
	そのような場合は filter: を編集した方がよいかもしれない.

	Filter Managerでフィルターを変更しても, filter: 自体が書き換わるわけではないので注意.
	万が一のときのために, 定期的にフィルターを書き出してバックアップを取っておいたほうがよい.


adblock#.uc.js Filter Managerについて

	「ツール」メニュー内にある「Organize adblock#.uc.js Filter...」をクリックすると, adblock#.uc.js Filter Manager(以下FM)が起動する.
	FMでは, フィルター一覧(フィルター/最終ヒット日時/ヒット回数)の閲覧, フィルターの追加/編集/削除/再読込, フィルターの「結果」(最終ヒット日時など)の削除,
	フィルターの書き出し, フィルターの最適化 が行える.
	UnDoはできないので, 大きな変更をするときには事前にバックアップをとることを推奨.

	* フィルターの追加
		入力欄に記入されたフィルターを, 1行ごとにフィルターとして追加する.
		自動的にフィルターの種類が判別されて追加される.

	* フィルターの編集
		基本的には, チェックしたフィルターの内容を入力欄で編集するという形になるが,
		内部的には チェックされたフィルターを削除 -> 入力欄に記入されたフィルターを追加 という処理をしているので, 
		追加/削除と編集を同時に行ったりもできる.
		また, 編集/削除した際には「結果」のデータも削除されるので, 選択したものと全く同じものを入力欄に入力して「編集」することで
		選択したものだけ「結果」を削除するということもできる.

	* フィルターの削除
		チェックしたものが削除される.

	* フィルターの再読込
		スクリプト内の filter: に書かれているフィルターを読み込む.
		Global Storageに保存されているフィルターは削除/上書きされるので注意.

	* フィルターの書き出し
		filter: 形式でフィルターを書き出す.

	* フィルターの最適化
		ヒット回数, 最終ヒット日時に基づいてヒットしやすいフィルターがより前にあるようにフィルターを並び替える.
		フィルターのマッチ処理は上から順番に試行されていくため, マッチ処理の短縮化が望める.


オプションについて

	スクリプト内に, 2つのオプションがある. いずれもtrue/falseで指定する. デフォルト値についてはスクリプト内を参照.
	共にパフォーマンスにはほとんど影響しません.

	starfilterWithoutPlus : アスタリスクフィルターを, 「+」なしで利用できるようにする.
							「*」がフィルター内に含まれているものを自動的にアスタリスクフィルターとして認識するようになる.

	forceLoadFromScript : 強制的に filter: から読み込むようにする.


adblock系リスト変換君.htmlについて

	ADB用フィルターを暫定的にadblock#.uc.js用フィルターへと変換するスクリプト.

	1. ADBフィルタリストをエクスポートし, 出てきたファイルの中身を「変換元」にコピペする.
	2. 「変換」を押すと「変換後」の所に変換されたものが出てくる.
		「フィルター」の所に出力されたものは, 
			filter:形式で書き出した場合: スクリプト内のfilter:の部分を上書き
			filter:形式で書き出していない場合: FMで追加
		すればよい.
		また, 「CSS」の所に出力されたものは, 要素非表示フィルターを変換したものなので,
		そのまま Stylish/userContent.css に貼り付ければよい.

	* コメント, 単純文字列, アスタリスク, (), 正規表現, 前方/後方一致, ホワイトリスト, 要素非表示フィルター対応
	* domain指定フィルター(「||」を使うもの)は, 単純に「||」が削除される. (ログに出力される)
	* Separator Character(「^」)は削除される. (ログに出力される)
	* フィルターオプション(「$」を使うもの)は削除される. (ログに出力される)

	* フィルタの重複は確認しない.
	* 変換に未対応のフィルタはそのままの文字列で出力される.
	* 作者はADBのフィルターについて(自慢じゃないけど)あまり詳しくないので, 念のため出力されたものは一度確認すること.
	* 一応 EasyList (https://easylist.adblockplus.org/easylist.txt) に載っているリストが大体変換されることを確認済.


注意

	* 要素を非表示にするCSSセレクタに対応する予定はない(userContent.css/Stylishでどうぞ).
	* このスクリプトは総じてあまりテストされていないので, 不具合がある可能性があります. α版レベルと考えて下さい.
	  このスクリプトを使用したことによって生じたいかなる損害もその責任を負いません.
	  すべて自己責任にてご使用下さい.
	* 10/12/30版で大幅な変更を行ったので, (いつも以上に)どこかしらにバグがあるかもしれない.


Version

	11/01/07 19:30 フィルターの最適化方法に誤りがあったのを修正
	11/01/06 20:50 空白行を追加するとFMが正しく表示されなくなるバグを修正
	11/01/06 17:40 フィルターの最適化ができるように
	11/01/05 17:10 ON/OFFが正しく切り替えられないことがあるバグを修正
	11/01/04 18:00 Firefox4でFMが起動できないバグを修正
	11/01/04 16:00 最後のwindowが閉じられたときにobserverを解除するようにした
	11/01/04 09:00 observerをwindow毎ではなく1回だけ登録するようにした
	11/01/03 17:00 FMで結果が正しく表示されないことがあるバグを修正
	11/01/01 00:30 正規表現フィルタが正しく動作していなかったのを修正
	10/12/31 22:00 結果が正しく保存されないバグを修正
	10/12/30 18:30 adblock#.uc.js Filter Manager を実装
	10/05/21 21:30 正規表現フィルタのマッチ処理を高速化
	10/05/21 20:40 アスタリスクフィルタを+無しでも機能するようにした
	10/05/21 20:30 マッチング処理を15%程度高速化
	09/09/15 19:30 typo
	09/09/14 18:00 ちょこっと高速化
	09/09/09 20:00 前方一致/後方一致フィルタに対応
	09/09/09 17:30 ホワイトリスト対応
	09/09/09 17:10 ON/OFFができるように
	09/08/31 10:30 高速化+メモリリーク対処
	09/08/31 09:30 アスタリスクフィルターが正しく動作していなかったのを修正
	09/08/30 22:00 /ads/のようなフィルターが正規表現と解釈されていたのを修正
	09/08/30 19:00 正規表現/アスタリスク/()を使用したフィルターに対応
	09/08/29 06:00 単純文字列/アスタリスク使用フィルターに対応(正規表現/()を使ったものには未対応)


ToDo

	* Adblock Adblock plus用リスト変換.html の変換精度向上
	* フィルタ結果のキャッシュ (これで速くなるのかどうかよく分からない)
	* フィルタのショートカット作成 (同上)
	* 高速化


参考

	* Writing Adblock Plus filters - http://adblockplus.org/en/filters



（ADBを使ったことない）俺用仕様なので使いにくいかも...
不便だと思った人は素直にADBを使って下さい.